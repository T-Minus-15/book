name: Deploy T-Minus-15 Agent Template

on:
  workflow_call:
    inputs:
      agent_name:
        description: 'Name of the agent to deploy (e.g., edmund, danny, ollie)'
        required: true
        type: string
      agent_version:
        description: 'Version of the agent'
        required: false
        type: string
        default: '1.0.0'
      environment:
        description: 'Deployment environment'
        required: false
        type: string
        default: 'development'
      azure_resource_group:
        description: 'Azure resource group name'
        required: false
        type: string
        default: 'tminus15-dev-rg'
      azure_workspace:
        description: 'Azure AI Foundry workspace name'
        required: false
        type: string
        default: 'tminus15-ai-workspace'
    secrets:
      AZURE_CREDENTIALS:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_CLIENT_ID:
        required: true
      GITHUB_TOKEN:
        required: true

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_RESOURCE_GROUP: ${{ inputs.azure_resource_group }}
  AZURE_WORKSPACE: ${{ inputs.azure_workspace }}
  AGENT_NAME: ${{ inputs.agent_name }}
  AGENT_VERSION: ${{ inputs.agent_version }}
  DEPLOYMENT_ENVIRONMENT: ${{ inputs.environment }}

jobs:
  validate-agent:
    name: Validate Agent Configuration
    runs-on: ubuntu-latest
    outputs:
      config-valid: ${{ steps.validate.outputs.valid }}
      agent-exists: ${{ steps.check-agent.outputs.exists }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Check agent directory exists
        id: check-agent
        run: |
          if [[ -d "agents/${{ env.AGENT_NAME }}" ]]; then
            echo "âœ… Agent directory found: agents/${{ env.AGENT_NAME }}"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Agent directory not found: agents/${{ env.AGENT_NAME }}"
            echo "exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Setup validation tools
        run: |
          npm install -g ajv-cli
          pip install yamllint
          
      - name: Validate agent configuration files
        id: validate
        run: |
          echo "Validating ${{ env.AGENT_NAME }} agent configuration..."
          
          # Check required files exist
          required_files=(
            "agents/${{ env.AGENT_NAME }}/${{ env.AGENT_NAME }}.md"
            "agents/${{ env.AGENT_NAME }}/agent-config.json"
            "agents/${{ env.AGENT_NAME }}/deployment.yaml"
          )
          
          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "âŒ Required file missing: $file"
              exit 1
            fi
          done
          
          # Validate JSON syntax
          if [[ -f "agents/${{ env.AGENT_NAME }}/agent-config.json" ]]; then
            if ! jq empty "agents/${{ env.AGENT_NAME }}/agent-config.json"; then
              echo "âŒ agent-config.json has invalid JSON syntax"
              exit 1
            fi
          fi
          
          if [[ -f "agents/${{ env.AGENT_NAME }}/knowledge-sources.json" ]]; then
            if ! jq empty "agents/${{ env.AGENT_NAME }}/knowledge-sources.json"; then
              echo "âŒ knowledge-sources.json has invalid JSON syntax"
              exit 1
            fi
          fi
          
          # Validate YAML syntax
          if [[ -f "agents/${{ env.AGENT_NAME }}/deployment.yaml" ]]; then
            if ! yamllint "agents/${{ env.AGENT_NAME }}/deployment.yaml"; then
              echo "âŒ deployment.yaml has invalid YAML syntax"
              exit 1
            fi
          fi
          
          echo "âœ… All configuration files are valid"
          echo "valid=true" >> $GITHUB_OUTPUT
          
      - name: Check T-Minus-15 knowledge source accessibility
        run: |
          echo "Checking T-Minus-15 repository accessibility..."
          if curl -s -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
             https://api.github.com/repos/bengweeks/T-Minus-15 > /dev/null; then
            echo "âœ… T-Minus-15 repository is accessible"
          else
            echo "âš ï¸ Warning: T-Minus-15 repository may not be accessible"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate-agent
    if: needs.validate-agent.outputs.config-valid == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Run security linting
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_JSON: true
          VALIDATE_YAML: true
          VALIDATE_MARKDOWN: true
          FILTER_REGEX_INCLUDE: "agents/${{ env.AGENT_NAME }}/.*"
          
      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./agents/${{ env.AGENT_NAME }}/
          base: main
          head: HEAD

  prepare-deployment:
    name: Prepare Deployment Package
    runs-on: ubuntu-latest
    needs: [validate-agent, security-scan]
    if: needs.validate-agent.outputs.config-valid == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create deployment package
        run: |
          echo "Creating deployment package for ${{ env.AGENT_NAME }}..."
          
          # Create deployment directory
          mkdir -p "deployment-packages/${{ env.AGENT_NAME }}"
          
          # Copy agent files
          cp -r "agents/${{ env.AGENT_NAME }}/"* "deployment-packages/${{ env.AGENT_NAME }}/"
          
          # Replace environment variables in configuration files
          if [[ -f "deployment-packages/${{ env.AGENT_NAME }}/agent-config.json" ]]; then
            envsubst < "deployment-packages/${{ env.AGENT_NAME }}/agent-config.json" > \
              "deployment-packages/${{ env.AGENT_NAME }}/agent-config.json.tmp"
            mv "deployment-packages/${{ env.AGENT_NAME }}/agent-config.json.tmp" \
               "deployment-packages/${{ env.AGENT_NAME }}/agent-config.json"
          fi
          
          if [[ -f "deployment-packages/${{ env.AGENT_NAME }}/deployment.yaml" ]]; then
            envsubst < "deployment-packages/${{ env.AGENT_NAME }}/deployment.yaml" > \
              "deployment-packages/${{ env.AGENT_NAME }}/deployment.yaml.tmp"
            mv "deployment-packages/${{ env.AGENT_NAME }}/deployment.yaml.tmp" \
               "deployment-packages/${{ env.AGENT_NAME }}/deployment.yaml"
          fi
          
          echo "âœ… Deployment package created"
          
      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: "${{ env.AGENT_NAME }}-deployment-package"
          path: "deployment-packages/${{ env.AGENT_NAME }}/"
          retention-days: 30

  deploy-to-azure:
    name: Deploy to Azure AI Foundry
    runs-on: ubuntu-latest
    needs: [validate-agent, security-scan, prepare-deployment]
    if: needs.validate-agent.outputs.config-valid == 'true'
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download deployment package
        uses: actions/download-artifact@v3
        with:
          name: "${{ env.AGENT_NAME }}-deployment-package"
          path: "./deployment-package"
          
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          
      - name: Ensure Azure Resource Group exists
        run: |
          echo "Ensuring resource group exists: ${{ env.AZURE_RESOURCE_GROUP }}"
          az group create \
            --name "${{ env.AZURE_RESOURCE_GROUP }}" \
            --location eastus \
            --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}" \
            --output table
            
      - name: Ensure Azure AI Foundry Workspace exists
        run: |
          echo "Ensuring AI Foundry workspace exists: ${{ env.AZURE_WORKSPACE }}"
          
          # Check if workspace exists
          if ! az ml workspace show \
              --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
              --name "${{ env.AZURE_WORKSPACE }}" \
              --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}" > /dev/null 2>&1; then
            
            echo "Creating new AI Foundry workspace..."
            az ml workspace create \
              --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
              --name "${{ env.AZURE_WORKSPACE }}" \
              --location eastus \
              --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}" \
              --output table
          else
            echo "âœ… Workspace already exists"
          fi
          
      - name: Deploy Agent to Azure AI Foundry
        run: |
          echo "Deploying ${{ env.AGENT_NAME }} agent to Azure AI Foundry..."
          
          # Deploy the agent (adjust based on actual Azure AI Foundry CLI commands)
          az ml model create \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --workspace-name "${{ env.AZURE_WORKSPACE }}" \
            --name "${{ env.AGENT_NAME }}" \
            --version "${{ env.AGENT_VERSION }}" \
            --path "./deployment-package" \
            --type "agent" \
            --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}" \
            --output table
            
      - name: Configure Knowledge Sources
        run: |
          echo "Configuring knowledge sources for ${{ env.AGENT_NAME }}..."
          
          # Configure knowledge source indexing
          # This would use Azure AI Foundry APIs to set up the GitHub repository indexing
          echo "Knowledge sources configured to auto-refresh from T-Minus-15 repository"
          
      - name: Run Post-Deployment Health Check
        run: |
          echo "Running health check for ${{ env.AGENT_NAME }}..."
          
          # Wait for deployment to complete
          sleep 30
          
          # Verify deployment
          az ml model show \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --workspace-name "${{ env.AZURE_WORKSPACE }}" \
            --name "${{ env.AGENT_NAME }}" \
            --version "${{ env.AGENT_VERSION }}" \
            --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}" \
            --output table
            
      - name: Post-deployment Summary
        if: success()
        run: |
          echo "ğŸš€ ${{ env.AGENT_NAME }} agent successfully deployed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Agent Name: ${{ env.AGENT_NAME }}"
          echo "Version: ${{ env.AGENT_VERSION }}"
          echo "Environment: ${{ env.DEPLOYMENT_ENVIRONMENT }}"
          echo "Resource Group: ${{ env.AZURE_RESOURCE_GROUP }}"
          echo "Workspace: ${{ env.AZURE_WORKSPACE }}"
          echo "Knowledge Source: https://github.com/bengweeks/T-Minus-15"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
      - name: Deployment Failure Notification
        if: failure()
        run: |
          echo "âŒ ${{ env.AGENT_NAME }} agent deployment failed!"
          echo "Please check the logs for details and retry the deployment."

  cleanup:
    name: Cleanup Artifacts
    runs-on: ubuntu-latest
    needs: [deploy-to-azure]
    if: always()
    
    steps:
      - name: Cleanup temporary resources
        run: |
          echo "Cleaning up temporary deployment artifacts..."
          # Additional cleanup logic if needed