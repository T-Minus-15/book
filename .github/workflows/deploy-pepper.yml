name: Deploy Pepper (the Planner)

on:
  push:
    branches: [ main ]
    paths: 
      - 'agents/pepper/**'
  pull_request:
    branches: [ main ]
    paths: 
      - 'agents/pepper/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  # Azure Configuration
  AZURE_SUBSCRIPTION_ID: "7620f9be-bf91-4297-ada2-659d2695b3a1"
  AZURE_TENANT_ID: "19ced85d-73f5-4193-8797-9fdce478db64"
  AZURE_LOCATION: "eastus"
  
  # Shared Infrastructure (from shared workflow)
  SHARED_RESOURCE_GROUP: "rg-tminus15-shared"
  AI_FOUNDRY_PROJECT: "t-minus-15-agents"
  
  # Pepper-specific configuration
  AGENT_NAME: "pepper"
  AGENT_DISPLAY_NAME: "Pepper (the Planner)"
  MODEL_DEPLOYMENT: "gpt-4o"
  MODEL_TEMPERATURE: "0.2"
  MODEL_MAX_TOKENS: "4096"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Validate Pepper configuration
      run: |
        cd agents/pepper
        
        echo "ðŸ” Validating Pepper (the Planner) configuration..."
        
        # Validate JSON syntax
        python -m json.tool agent-config.json > /dev/null
        echo "âœ… agent-config.json is valid JSON"
        
        # Pepper-specific validations
        python -c "
        import json
        with open('agent-config.json', 'r') as f:
            config = json.load(f)
        
        # Check required fields
        required_fields = ['agent', 'model', 'instructions']
        for field in required_fields:
            if field not in config:
                raise ValueError(f'Missing required field: {field}')
        
        # Pepper-specific checks
        instructions = config.get('instructions', {}).get('systemPrompt', '').lower()
        if 'planning' not in instructions and 'requirements' not in instructions:
            print('âš ï¸ Warning: Pepper instructions should mention planning or requirements')
        
        if config.get('agent', {}).get('name') != 'Pepper':
            print('âš ï¸ Warning: Agent name should be Pepper')
        
        # Check for analysis capabilities
        capabilities = config.get('instructions', {}).get('capabilities', [])
        if not any('requirements' in cap.lower() for cap in capabilities):
            print('âš ï¸ Warning: Pepper should have requirements analysis capabilities')
        
        print('âœ… Pepper configuration validation passed')
        "

  deploy:
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    environment: ${{ github.event.inputs.environment || 'development' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set up environment variables
      run: |
        ENVIRONMENT="${{ github.event.inputs.environment || 'development' }}"
        
        # Use shared infrastructure with environment suffix
        if [ "$ENVIRONMENT" != "production" ]; then
          RESOURCE_GROUP="${{ env.SHARED_RESOURCE_GROUP }}-${ENVIRONMENT}"
          AI_FOUNDRY_PROJECT="${{ env.AI_FOUNDRY_PROJECT }}-${ENVIRONMENT}"
        else
          RESOURCE_GROUP="${{ env.SHARED_RESOURCE_GROUP }}"
          AI_FOUNDRY_PROJECT="${{ env.AI_FOUNDRY_PROJECT }}"
        fi
        
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
        echo "RESOURCE_GROUP=$RESOURCE_GROUP" >> $GITHUB_ENV
        echo "AI_FOUNDRY_PROJECT=$AI_FOUNDRY_PROJECT" >> $GITHUB_ENV
        
        echo "ðŸš€ Deploying Pepper (the Planner) to $ENVIRONMENT environment"
        echo "Shared Resource Group: $RESOURCE_GROUP"
        echo "Shared AI Foundry Project: $AI_FOUNDRY_PROJECT"
    
    - name: Verify shared infrastructure
      run: |
        echo "ðŸ” Verifying shared infrastructure exists..."
        
        if ! az group show --name "$RESOURCE_GROUP" >/dev/null 2>&1; then
          echo "âŒ Shared resource group $RESOURCE_GROUP does not exist"
          echo "ðŸ’¡ Please run: gh workflow run deploy-shared-infrastructure.yml -f environment=$ENVIRONMENT"
          exit 1
        fi
        
        if ! az ml workspace show --name "$AI_FOUNDRY_PROJECT" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
          echo "âŒ Shared AI Foundry project $AI_FOUNDRY_PROJECT does not exist"
          echo "ðŸ’¡ Please run the shared infrastructure workflow first"
          exit 1
        fi
        
        echo "âœ… Shared infrastructure verified"
    
    - name: Deploy Pepper to shared project
      run: |
        cd agents/pepper
        
        echo "ðŸ“‹ Deploying Pepper (the Planner) to shared AI Foundry project..."
        
        # Read Pepper's configuration
        INSTRUCTIONS=$(cat agent-config.json | jq -r '.instructions.systemPrompt')
        TEMPERATURE=$(cat agent-config.json | jq -r '.model.temperature // 0.2')
        MAX_TOKENS=$(cat agent-config.json | jq -r '.model.maxTokens // 4096')
        
        echo "ðŸ“ Pepper Configuration:"
        echo "  Role: Business Analyst & Requirements Planner"
        echo "  Primary Model: ${{ env.MODEL_DEPLOYMENT }}"
        echo "  Temperature: $TEMPERATURE (analytical responses)"
        echo "  Max Tokens: $MAX_TOKENS"
        echo "  Tools: Code interpreter, File search, Document analysis"
        
        # Create Pepper-specific agent payload
        cat > pepper-agent-config.json << EOF
        {
          "name": "pepper-planner",
          "display_name": "${{ env.AGENT_DISPLAY_NAME }}",
          "instructions": "$INSTRUCTIONS",
          "model": "${{ env.MODEL_DEPLOYMENT }}",
          "temperature": $TEMPERATURE,
          "max_tokens": $MAX_TOKENS,
          "tools": [
            {"type": "code_interpreter"},
            {"type": "file_search"}
          ],
          "capabilities": [
            "Requirements gathering and analysis",
            "Stakeholder management and communication",
            "User story creation and refinement",
            "Project scope definition",
            "Risk assessment and mitigation",
            "Business process analysis",
            "Acceptance criteria definition",
            "Sprint planning and backlog management"
          ],
          "knowledge_sources": [
            "tminus15-methodology",
            "business-analysis-frameworks",
            "requirements-templates",
            "stakeholder-management"
          ],
          "project": "$AI_FOUNDRY_PROJECT",
          "resource_group": "$RESOURCE_GROUP",
          "metadata": {
            "agent_role": "planner",
            "specialization": "Requirements Analysis, Business Planning, Stakeholder Management",
            "methodology": "T-Minus-15",
            "environment": "$ENVIRONMENT",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
        }
        EOF
        
        echo "ðŸ“„ Pepper agent configuration ready"
        cat pepper-agent-config.json | jq .
        
        echo "âœ… Pepper configured for shared AI Foundry project"
    
    - name: Test Pepper deployment
      run: |
        echo "ðŸ§ª Testing Pepper deployment..."
        
        # Verify shared project access
        az ml workspace show --name "$AI_FOUNDRY_PROJECT" --resource-group "$RESOURCE_GROUP" --output table
        
        echo "âœ… Pepper deployment test completed"
    
    - name: Output Pepper deployment info
      run: |
        SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        
        echo "=========================================="
        echo "ðŸ“‹ Pepper (the Planner) Deployed!"
        echo "=========================================="
        echo ""
        echo "ðŸ¤– Agent Details:"
        echo "  Name: Pepper"
        echo "  Role: Planner (Business Analysis & Requirements)"
        echo "  Specialization: Requirements Gathering, Stakeholder Management"
        echo "  Environment: $ENVIRONMENT"
        echo ""
        echo "ðŸ§  AI Configuration:"
        echo "  Primary Model: ${{ env.MODEL_DEPLOYMENT }} (analytical reasoning)"
        echo "  Temperature: ${{ env.MODEL_TEMPERATURE }} (focused analysis)"
        echo "  Max Tokens: ${{ env.MODEL_MAX_TOKENS }}"
        echo ""
        echo "ðŸ—ï¸ Shared Infrastructure:"
        echo "  Resource Group: $RESOURCE_GROUP"
        echo "  AI Foundry Project: $AI_FOUNDRY_PROJECT (shared with all agents)"
        echo ""
        echo "ðŸŒ Portal Access:"
        echo "  Azure Portal: https://portal.azure.com/#@evrosdemo.onmicrosoft.com/resource/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP"
        echo "  AI Foundry: https://ai.azure.com/"
        echo ""
        echo "ðŸŽ¯ Capabilities:"
        echo "  ðŸ“Š Requirements gathering and analysis"
        echo "  ðŸ¤ Stakeholder management and communication"
        echo "  ðŸ“ User story creation and refinement"
        echo "  ðŸŽ¯ Project scope definition and management"
        echo "  âš ï¸ Risk assessment and mitigation planning"
        echo "  ðŸ“‹ Business process analysis and optimization"
        echo "  âœ… Acceptance criteria definition"
        echo "  ðŸ—“ï¸ Sprint planning and backlog management"
        echo ""
        echo "ðŸ¤ Collaboration:"
        echo "  ðŸŽ¨ Works with Danny on user experience requirements"
        echo "  âš™ï¸ Collaborates with Edmund on technical feasibility"
        echo "  ðŸ“Š Coordinates with Poppy on project planning"
        echo "  ðŸ§ª Partners with Teddy on acceptance criteria"
        echo ""
        echo "ðŸ“‹ Pepper is ready to plan your T-Minus-15 projects!"