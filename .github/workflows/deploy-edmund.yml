name: Deploy Edmund (the Engineer)

on:
  push:
    branches: [ main ]
    paths: 
      - 'agents/edmund/**'
  pull_request:
    branches: [ main ]
    paths: 
      - 'agents/edmund/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_LOCATION: eastus
  AGENT_NAME: edmund
  AGENT_DISPLAY_NAME: "Edmund (the Engineer)"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jsonschema pyyaml azure-ai-ml azure-identity
    
    - name: Validate Edmund configuration
      run: |
        cd agents/edmund
        
        echo "üîç Validating Edmund (the Engineer) configuration..."
        
        # Validate JSON syntax
        python -m json.tool agent-config.json > /dev/null
        echo "‚úÖ agent-config.json is valid JSON"
        
        # Check required fields for Edmund
        python -c "
        import json
        with open('agent-config.json', 'r') as f:
            config = json.load(f)
        
        required_fields = ['agent', 'model', 'instructions']
        for field in required_fields:
            if field not in config:
                raise ValueError(f'Missing required field: {field}')
        
        # Edmund-specific validations
        if 'T-Minus-15' not in config.get('instructions', {}).get('systemPrompt', ''):
            print('‚ö†Ô∏è Warning: Edmund instructions should mention T-Minus-15 methodology')
        
        if config.get('agent', {}).get('name') != 'Edmund':
            print('‚ö†Ô∏è Warning: Agent name should be Edmund')
        
        print('‚úÖ Edmund configuration validation passed')
        "
        
        # Validate Bicep templates
        if [ -f "infra/main.bicep" ]; then
          echo "‚úÖ Bicep infrastructure templates found"
        else
          echo "‚ö†Ô∏è No Bicep templates found - will use basic deployment"
        fi

  deploy:
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    environment: ${{ github.event.inputs.environment || 'development' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set up environment variables
      run: |
        ENVIRONMENT="${{ github.event.inputs.environment || 'development' }}"
        RESOURCE_GROUP="rg-edmund-${ENVIRONMENT}"
        PROJECT_NAME="edmund-tminus15-${ENVIRONMENT}"
        
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
        echo "RESOURCE_GROUP=$RESOURCE_GROUP" >> $GITHUB_ENV
        echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV
        
        echo "üöÄ Deploying Edmund (the Engineer) to $ENVIRONMENT environment"
        echo "Resource Group: $RESOURCE_GROUP"
        echo "Project Name: $PROJECT_NAME"
        echo "Location: $AZURE_LOCATION"
    
    - name: Create resource group
      run: |
        echo "üìÅ Creating resource group for Edmund..."
        az group create \
          --name "$RESOURCE_GROUP" \
          --location "$AZURE_LOCATION" \
          --tags \
            agent="edmund" \
            role="engineer" \
            methodology="t-minus-15" \
            environment="$ENVIRONMENT"
        
        echo "‚úÖ Resource group $RESOURCE_GROUP ready"
    
    - name: Deploy Edmund infrastructure
      run: |
        cd agents/edmund
        
        echo "üèóÔ∏è Deploying Edmund's infrastructure..."
        
        if [ -f "infra/main.bicep" ]; then
          echo "üìã Using Bicep templates for Edmund"
          
          DEPLOYMENT_NAME="edmund-deployment-$(date +%Y%m%d-%H%M%S)"
          
          # Deploy Edmund's specialized infrastructure
          az deployment group create \
            --resource-group "$RESOURCE_GROUP" \
            --name "$DEPLOYMENT_NAME" \
            --template-file infra/main.bicep \
            --parameters infra/main.parameters.json \
            --parameters projectName="$PROJECT_NAME" \
            --parameters agentName="edmund" \
            --parameters agentRole="engineer" \
            --parameters modelDeployment="gpt-4o" \
            --output table
          
          echo "‚úÖ Edmund infrastructure deployed successfully"
          
        else
          echo "üîß Creating basic AI Foundry setup for Edmund..."
          
          # Create AI Services account optimized for engineering tasks
          AI_SERVICE_NAME="${PROJECT_NAME}-ai-service"
          
          az cognitiveservices account create \
            --name "$AI_SERVICE_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --location "$AZURE_LOCATION" \
            --kind "AIServices" \
            --sku "S0" \
            --tags \
              agent="edmund" \
              role="engineer" \
              capabilities="code-interpreter,file-search" \
            --yes
          
          echo "‚úÖ Basic AI infrastructure ready for Edmund"
        fi
    
    - name: Configure Edmund agent
      run: |
        cd agents/edmund
        
        echo "ü§ñ Configuring Edmund (the Engineer) in AI Foundry..."
        
        # Read Edmund's specific configuration
        INSTRUCTIONS=$(cat agent-config.json | jq -r '.instructions.systemPrompt')
        TEMPERATURE=$(cat agent-config.json | jq -r '.model.temperature // 0.1')
        MAX_TOKENS=$(cat agent-config.json | jq -r '.model.maxTokens // 4096')
        
        echo "üìù Edmund Configuration:"
        echo "  Instructions: Engineering focus with T-Minus-15 methodology"
        echo "  Temperature: $TEMPERATURE (focused responses)"
        echo "  Max Tokens: $MAX_TOKENS"
        echo "  Tools: Code interpreter, File search"
        
        # Create Edmund-specific agent payload
        cat > edmund-agent-payload.json << EOF
        {
          "name": "edmund-engineer",
          "instructions": "$INSTRUCTIONS",
          "model": "gpt-4o",
          "temperature": $TEMPERATURE,
          "max_tokens": $MAX_TOKENS,
          "tools": [
            {"type": "code_interpreter"},
            {"type": "file_search"}
          ],
          "metadata": {
            "agent_name": "Edmund",
            "role": "Engineer", 
            "specialization": "DevOps, Infrastructure, Code Development",
            "methodology": "T-Minus-15",
            "version": "1.0.0",
            "environment": "$ENVIRONMENT",
            "deployed_by": "github_actions",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
        }
        EOF
        
        echo "üìÑ Edmund agent configuration ready"
        cat edmund-agent-payload.json | jq .
    
    - name: Setup Edmund's knowledge sources
      run: |
        cd agents/edmund
        
        echo "üìö Setting up Edmund's knowledge sources..."
        
        if [ -f "knowledge-sources.json" ]; then
          echo "üìñ Found knowledge sources configuration for Edmund"
          
          # Extract T-Minus-15 repository URL
          REPO_URL=$(cat knowledge-sources.json | jq -r '.knowledgeSources[0].source.url // "https://github.com/bengweeks/T-Minus-15"')
          
          echo "üîó Primary knowledge source: $REPO_URL"
          echo "üìÖ Refresh schedule: Daily (T-Minus-15 methodology)"
          echo "üìë File types: .md, .adoc, .yml, .txt"
          
          # Validate repository access
          if curl -s -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$REPO_URL" > /dev/null; then
            echo "‚úÖ Knowledge source accessible"
          else
            echo "‚ö†Ô∏è Knowledge source may not be accessible"
          fi
        else
          echo "‚ö†Ô∏è No knowledge sources configuration found"
          echo "üí° Edmund will use default T-Minus-15 knowledge"
        fi
    
    - name: Test Edmund deployment
      run: |
        echo "üß™ Testing Edmund deployment..."
        
        # Verify resource group
        az group show --name "$RESOURCE_GROUP" --output table
        
        # List deployed resources
        echo "üìã Resources deployed for Edmund:"
        az resource list --resource-group "$RESOURCE_GROUP" --output table
        
        echo "‚úÖ Edmund deployment test completed"
    
    - name: Output Edmund deployment info
      run: |
        SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        
        echo "=========================================="
        echo "üéâ Edmund (the Engineer) Deployed!"
        echo "=========================================="
        echo ""
        echo "ü§ñ Agent Details:"
        echo "  Name: Edmund"
        echo "  Role: Engineer (DevOps & Development)"
        echo "  Specialization: T-Minus-15 Methodology"
        echo "  Environment: $ENVIRONMENT"
        echo ""
        echo "üèóÔ∏è Infrastructure:"
        echo "  Resource Group: $RESOURCE_GROUP"
        echo "  Project Name: $PROJECT_NAME"
        echo "  Location: $AZURE_LOCATION"
        echo ""
        echo "üåê Portal Access:"
        echo "  Azure Portal: https://portal.azure.com/#@evrosdemo.onmicrosoft.com/resource/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP"
        echo "  AI Foundry: https://ai.azure.com/"
        echo ""
        echo "üéØ Next Steps:"
        echo "  1. Visit AI Foundry portal to complete agent setup"
        echo "  2. Configure GPT-4o model deployment"
        echo "  3. Test Edmund with T-Minus-15 methodology questions"
        echo "  4. Set up knowledge base integration"
        echo ""
        echo "‚öôÔ∏è Edmund is ready to help with your engineering tasks!"