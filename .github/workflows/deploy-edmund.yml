name: Deploy Edmund Agent

on:
  push:
    branches: [main]
    paths: 
      - 'agents/edmund/**'
      - '.github/workflows/deploy-edmund.yml'
  pull_request:
    branches: [main]
    paths:
      - 'agents/edmund/**'
      - '.github/workflows/deploy-edmund.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_RESOURCE_GROUP: 'tminus15-dev-rg'
  AGENT_NAME: 'edmund'
  AGENT_VERSION: '1.0.0'

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      config-valid: ${{ steps.validate.outputs.valid }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install validation tools
        run: |
          npm install -g ajv-cli
          pip install yamllint
          
      - name: Validate JSON configurations
        id: validate
        run: |
          echo "Validating Edmund agent configuration..."
          
          # Validate JSON syntax
          if ! jq empty agents/edmund/agent-config.json; then
            echo "‚ùå agent-config.json has invalid JSON syntax"
            exit 1
          fi
          
          if ! jq empty agents/edmund/knowledge-sources.json; then
            echo "‚ùå knowledge-sources.json has invalid JSON syntax"
            exit 1
          fi
          
          # Validate YAML syntax
          if ! yamllint agents/edmund/deployment.yaml; then
            echo "‚ùå deployment.yaml has invalid YAML syntax"
            exit 1
          fi
          
          echo "‚úÖ All configuration files are valid"
          echo "valid=true" >> $GITHUB_OUTPUT
          
      - name: Check T-Minus-15 documentation accessibility
        run: |
          echo "Checking GitHub repository accessibility..."
          if curl -s -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
             https://api.github.com/repos/bengweeks/T-Minus-15 > /dev/null; then
            echo "‚úÖ T-Minus-15 repository is accessible"
          else
            echo "‚ö†Ô∏è Warning: T-Minus-15 repository may not be accessible"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.config-valid == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Run security scan
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_JSON: true
          VALIDATE_YAML: true
          VALIDATE_MARKDOWN: true
          
      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./agents/edmund/
          base: main
          head: HEAD

  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [validate, security-scan]
    if: |
      needs.validate.outputs.config-valid == 'true' &&
      (github.ref == 'refs/heads/main' || github.event.inputs.environment == 'development')
    environment: development
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Setup Azure CLI
        uses: azure/CLI@v1
        with:
          azcliversion: latest
          
      - name: Create Azure Resource Group
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location eastus \
            --subscription ${{ env.AZURE_SUBSCRIPTION_ID }}
            
      - name: Deploy Azure AI Foundry Workspace
        run: |
          echo "Deploying Azure AI Foundry workspace..."
          az ml workspace create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name "tminus15-ai-workspace" \
            --location eastus
            
      - name: Deploy Edmund Agent Configuration
        run: |
          echo "Deploying Edmund agent to Azure AI Foundry..."
          
          # Create agent deployment package
          mkdir -p deployment-package
          cp -r agents/edmund/* deployment-package/
          
          # Replace environment variables in configuration
          envsubst < agents/edmund/agent-config.json > deployment-package/agent-config.json
          envsubst < agents/edmund/deployment.yaml > deployment-package/deployment.yaml
          
          # Deploy using Azure CLI (adjust based on actual Azure AI Foundry CLI)
          az ml model create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --workspace-name "tminus15-ai-workspace" \
            --name "${{ env.AGENT_NAME }}" \
            --version "${{ env.AGENT_VERSION }}" \
            --path "./deployment-package" \
            --type "agent"
            
      - name: Update Knowledge Sources
        run: |
          echo "Triggering knowledge source indexing..."
          # This would typically call Azure AI Foundry APIs to refresh knowledge sources
          # Placeholder for actual implementation
          echo "Knowledge sources configured to auto-refresh from GitHub"
          
      - name: Run Health Check
        run: |
          echo "Running agent health check..."
          sleep 30  # Wait for deployment to complete
          
          # Health check implementation would go here
          # For now, just verify the deployment exists
          az ml model show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --workspace-name "tminus15-ai-workspace" \
            --name "${{ env.AGENT_NAME }}" \
            --version "${{ env.AGENT_VERSION }}"
            
      - name: Post-deployment notification
        if: success()
        run: |
          echo "üöÄ Edmund agent successfully deployed to development environment!"
          echo "Agent Name: ${{ env.AGENT_NAME }}"
          echo "Version: ${{ env.AGENT_VERSION }}"
          echo "Environment: development"
          echo "Knowledge Source: https://github.com/bengweeks/T-Minus-15"
          
      - name: Deployment failure notification
        if: failure()
        run: |
          echo "‚ùå Edmund agent deployment failed!"
          echo "Please check the logs for details."

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [validate, security-scan, deploy-development]
    if: |
      needs.validate.outputs.config-valid == 'true' &&
      github.event.inputs.environment == 'staging'
    environment: staging
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Deploy to Staging Environment
        run: |
          echo "Deploying Edmund to staging environment..."
          # Staging deployment logic would go here
          # Similar to development but with staging-specific configurations

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, security-scan, deploy-staging]
    if: |
      needs.validate.outputs.config-valid == 'true' &&
      github.event.inputs.environment == 'production'
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Deploy to Production Environment
        run: |
          echo "Deploying Edmund to production environment..."
          # Production deployment logic would go here
          # Similar to development but with production-specific configurations

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-development, deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: Cleanup temporary resources
        run: |
          echo "Cleaning up temporary deployment artifacts..."
          # Cleanup logic if needed